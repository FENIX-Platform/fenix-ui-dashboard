define(["fenix-ui-bridge","jquery","loglevel","underscore","fenix-ui-converter","fenix-ui-filter-utils","amplify-pubsub","fenix-ui-visualization-box","fenix-ui-chart-creator","fenix-ui-map-creator","fenix-ui-table-creator"],function(t,e,i,s,r,n,o,a,h,c,p){return function(t){function e(s){if(i[s])return i[s].exports;var r=i[s]={exports:{},id:s,loaded:!1};return t[s].call(r.exports,r,r.exports,e),r.loaded=!0,r.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e,i){t.exports=i(1)},function(t,e,i){var s,r;s=[i(3),i(8),i(4),i(5),i(6),i(7),i(2),i(9),i(10),i(11)],r=function(t,e,s,r,n,o,a,h,c,p){"use strict";function u(i){s.info("FENIX Dashboard"),s.info(i),t.extend(!0,this,o,{initial:i},d),this._parseInput(i);var r=this._validateInput();return r===!0?(this._initVariables(),this._preloadMetadataResource().then(e.bind(this._preloadMetadataResourceSuccess,this),e.bind(this._preloadMetadataResourceError,this)),this):(s.error("Impossible to create Dashboard"),void s.error(r))}var d={lang:"EN"},l="./items/";return u.prototype.refresh=function(t){this.ready!==!0?this.toSync=t:this._refresh(t)},u.prototype.on=function(t,e,i){var s=i||this;return this.channels[t]||(this.channels[t]=[]),this.channels[t].push({context:s,callback:e}),this},u.prototype._refresh=function(t){t.values||s.warn("Refresh values is not valid. Missing values.values field. Is it FENIX plain filter format?"),this.values=t.values,this._disposeItems(),this._renderDashboard(),s.info("Dashboard refresh")},u.prototype._trigger=function(t){if(!this.channels[t])return!1;for(var e=Array.prototype.slice.call(arguments,1),i=0,s=this.channels[t].length;i<s;i++){var r=this.channels[t][i];r.callback.apply(r.context,e)}return this},u.prototype._parseInput=function(){this.uid=this.initial.uid,this.el=this.initial.el||window.document,this.version=this.initial.version,this.items=this.initial.items||[],this.preProcess=this.initial.preProcess||[],this.postProcess=this.initial.postProcess||[],this.commonFilter=this.initial.filter||{},this.environment=this.initial.environment,this.cache="boolean"==typeof this.initial.cache?this.initial.cache:o.cache,this.itemsRegistry=t.extend(!0,{},o.itemsRegistry,this.initial.itemsRegistry),this.filter=this.initial.filter,this.$el=t(this.el),this.types=[],this.ids=[]},u.prototype._validateInput=function(){var t=!0,i=[];return this.id||(window.fx_Dashboard_id>=0?window.fx_Dashboard_id++:window.fx_Dashboard_id=0,this.id=String(window.fx_Dashboard_id),s.info("Set dashboard id to: "+this.id)),this.uid||(i.push({code:r.MISSING_UID}),s.error("Impossible to find resource uid")),this.items&&Array.isArray(this.items)||(i.push({code:r.INVALID_ITEMS}),s.error("Invalid items configuration")),e.each(this.items,e.bind(function(t){t.hasOwnProperty("id")?(e.contains(this.ids,t.id)&&(i.push({code:r.ITEM_DUPLICATED_ID}),s.error("Duplicated item's id: "+t.id),s.error(t)),this.ids.push(t.id),this.ids=e.uniq(this.ids)):(i.push({code:r.ITEM_MISSING_ID}),s.error("Missing item's id"),s.error(t));var n=this._getItemContainer(t.id);1!==n.length&&(i.push({code:r.ITEM_MISSING_CONTAINER}),s.error("Missing item's container"),s.error(t)),t.hasOwnProperty("type")?(this.types.push(t.type),this.types=e.uniq(this.types)):(i.push({code:r.ITEM_MISSING_TYPE}),s.error("Missing item's type"),s.error(t))},this)),Array.isArray(this.preProcess)||(i.push({code:r.INVALID_PRE_PROCESS}),s.error("Invalid items pre process")),Array.isArray(this.postProcess)||(i.push({code:r.INVALID_POST_PROCESS}),s.error("Invalid items pre process")),i.length>0?i:t},u.prototype._initVariables=function(){this.channels={},this.itemInstances={},this.bridge=new a({environment:this.environment}),this.filter&&(this.values=this.filter.hasOwnProperty("values")?this.filter.values:this.filter)},u.prototype._getItemContainer=function(t){return this.$el.find("[data-item='"+t+"']")},u.prototype._getItemScriptPath=function(e){var i,r=t.extend(!0,{},this.itemsRegistry),n=r[e];return n||s.error('Registration not found for "'+e+'" item.'),n.path?i=n.path:s.error('Impossible to find path configuration for "'+e+' item".'),l+i},u.prototype._preloadMetadataResource=function(){return this.bridge.getMetadata({uid:this.uid,version:this.version,cache:this.cache,params:{dsd:!0,full:!0}})},u.prototype._preloadMetadataResourceError=function(){s.error("Resources load: error")},u.prototype._preloadMetadataResourceSuccess=function(e){s.info("Metadata loaded"),this.model={metadata:e},this.filterConfiguration=c.createConfiguration({model:t.extend(!0,{},this.model)}),this._renderDashboard()},u.prototype._renderDashboard=function(){this._renderItems()},u.prototype._renderItems=function(){this.ready=!1,this.itemsReady=0,this.items.length>0?this.validTimeout=window.setTimeout(function(){s.error(r.READY_TIMEOUT)},o.validityTimeout):window.setTimeout(e.bind(function(){this._onReady()},this),100),e.each(this.items,e.bind(function(i){i.filter=t.extend({},i.filter,this.values),i.body=this._createProcessBody(i),this._getProcessedResource(i).then(e.bind(this._onGetProcessedResourceSuccess,this,i),e.bind(this._onGetProcessedResourceError,this,i))},this))},u.prototype._getProcessedResource=function(i){function s(t){var i=e.filter(t,function(t){return t.hasOwnProperty("sid")})||[];return Array.isArray(t)&&i.length>0}var r=s(i.body);return this.bridge.getProcessedResource(t.extend({body:i.body,params:{dsd:!0,full:!0,language:this.lang}},r?null:{uid:this.uid,version:this.version}))},u.prototype._createProcessBody=function(i){function r(i){if(!e.isEmpty(i))return o=t.extend(!0,{},h.toD3P(p.filterConfiguration,{values:p.commonFilter}),h.toD3P(p.filterConfiguration,{values:i})),{name:"filter",parameters:{rows:o}}}function n(t){var r={};return 0!==t.length?e.each(t,function(t){d.hasOwnProperty(t)?r[t]=d[t]:s.warn("Item "+i.id+": filter "+t+" not included because not present in item.filterFor")}):r=d,r}var o,a,c,p=this,u=i.filterFor||[],d=i.filter||{},l={};if(a=e.union(this.preProcess,i.preProcess)||[],c=e.union(this.postProcess,i.postProcess),Array.isArray(u)){s.info("Apply 'filter' to process chain"),l=n(u);var f=r(l);f&&a.push(f),a=e.union(a,c)}else s.info("Apply 'filter' to process step"),a=e.union(a,c),e.each(u,function(i,o){s.info("rid: "+o);var h,c,u=e.filter(a,function(t){return p.getNestedProperty("rid.uid",t)===o})||[];u.length>1&&s.error("Rid "+o+" is not unique in configuration."),c=u[0],c?(s.info("Step found:"),l=n(i),e.each(l,function(t,e){Array.isArray(t)&&0===t.length&&c.parameters&&c.parameters.rows&&delete c.parameters.rows[e]}),h=r(l),t.extend(!0,c,h)):s.warn("Filter for rid: "+o+" was specified but no step was found")});return s.info("Body for item id ["+i.id+"]: "),s.info(a),a},u.prototype._onGetProcessedResourceError=function(t){s.error("Resources load: error"),s.error(t)},u.prototype._onGetProcessedResourceSuccess=function(t,e){s.info("Resources load: success"),t.model=this._updateModel(e),this._renderItem(t)},u.prototype._renderItem=function(i){var s=this._getItemRender(i.type),r=t.extend(!0,{},i,{controller:this,el:this._getItemContainer(i.id)}),n=new s(r);n.on("ready",e.bind(this._onItemReady,this,i)),this.itemInstances[i.id]=n},u.prototype._onItemReady=function(t){this.itemsReady++,this.itemsReady===this.items.length?(this.ready=!0,s.info("All items are ready"),this._onReady()):this._trigger("ready.item",t)},u.prototype._onReady=function(){if(s.info("Dashboard ["+this.id+"] is ready"),window.clearTimeout(this.validTimeout),this.toSync){var e=t.extend(!0,{},this.toSync);delete this.toSync,this._refresh(e)}else p.publish(this._getEventName(n.DASHBOARD_READY)),this._trigger("ready")},u.prototype._getEventName=function(t){return this.id.concat(t)},u.prototype._getItemRender=function(t){return i(12)(this._getItemScriptPath(t)+".js")},u.prototype._getSelectorInstance=function(t){var e=this.selectors[t].instance;return e||s.warn("Impossible to find selector instance for "+t),e},u.prototype._bindEventListeners=function(){},u.prototype._updateModel=function(t){var i=this.model||{},s=this.getNestedProperty("metadata",t),r=this.getNestedProperty("dsd",s)||{},n=this.getNestedProperty("data",t),o=this.getNestedProperty("size",t),a=e.without(Object.keys(r),"rid");return a.length>0&&this.assign(i,"metadata.dsd",r),Array.isArray(n)?this.assign(i,"data",n):i.data=[],i.size!==o&&this.assign(i,"size",o),this.model=i,i},u.prototype._unbindEventListeners=function(){},u.prototype._disposeItems=function(){e.each(this.itemInstances,function(t){t.dispose()})},u.prototype.dispose=function(){this._disposeItems(),this._unbindEventListeners()},u.prototype.assign=function(t,e,i){if("string"==typeof e&&(e=e.split(".")),e.length>1){var s=e.shift();this.assign(t[s]="[object Object]"===Object.prototype.toString.call(t[s])?t[s]:{},e,i)}else t[e[0]]=i},u.prototype.getNestedProperty=function(e,i){for(var i=t.extend(!0,{},i),s=e.split(".");s.length&&(i=i[s.shift()]););return i},u}.apply(e,s),!(void 0!==r&&(t.exports=r))},function(e,i){e.exports=t},function(t,i){t.exports=e},function(t,e){t.exports=i},function(t,e,i){var s;s=function(){"use strict";var t="";return{MISSING_UID:t+"missing_uid",INVALID_ITEMS:t+"invalid_items",INVALID_PRE_PROCESS:t+"invalid_pre_process",INVALID_POST_PROCESS:t+"invalid_post_process",ITEM_MISSING_ID:t+"item_missing_id",ITEM_MISSING_TYPE:t+"item_missing_type",ITEM_MISSING_CONTAINER:t+"item_missing_container",ITEM_DUPLICATED_ID:t+"item_duplicated_id",READY_TIMEOUT:t+"dashboard.timeout"}}.call(e,i,e,t),!(void 0!==s&&(t.exports=s))},function(t,e,i){var s;s=function(){"use strict";var t="fx.dashboard.";return{ITEM_READY:t+"item.ready",DASHBOARD_READY:t+"dashboard.ready"}}.call(e,i,e,t),!(void 0!==s&&(t.exports=s))},function(t,e,i){var s;s=function(){"use strict";return{validityTimeout:1e4,cache:!1,itemsRegistry:{chart:{path:"chart"},map:{path:"map"},table:{path:"table"},box:{path:"box"}}}}.call(e,i,e,t),!(void 0!==s&&(t.exports=s))},function(t,e){t.exports=s},function(t,e){t.exports=r},function(t,e){t.exports=n},function(t,e){t.exports=o},function(t,e,i){function s(t){return i(r(t))}function r(t){return n[t]||function(){throw new Error("Cannot find module '"+t+"'.")}()}var n={"./index.js":1,"./items/box.js":13,"./items/chart.js":15,"./items/map.js":17,"./items/table.js":19};s.keys=function(){return Object.keys(n)},s.resolve=r,t.exports=s,s.id=12},function(t,e,i){var s,r;s=[i(3),i(4),i(8),i(5),i(6),i(7),i(14),i(11)],r=function(t,e,i,s,r,n,o,a){"use strict";function h(e){var i=this;return t.extend(!0,this,c,e),this.$el=t(this.el),this._renderTemplate(),this._initVariables(),this.renderBoxTab(),this._bindEventListeners(),window.setTimeout(function(){i.status.ready=!0,a.publish(i._getEventName(r.SELECTOR_READY),i),i._trigger("ready")},0),this}var c={};return h.prototype.dispose=function(){this._dispose(),e.info("Selector disposed successfully")},h.prototype.refresh=function(){e.info("Item refresh successfully")},h.prototype.on=function(t,e,i){var s=i||this;return this.channels[t]||(this.channels[t]=[]),this.channels[t].push({context:s,callback:e}),this},h.prototype._trigger=function(t){if(!this.channels[t])return!1;for(var e=Array.prototype.slice.call(arguments,1),i=0,s=this.channels[t].length;i<s;i++){var r=this.channels[t][i];r.callback.apply(r.context,e)}return this},h.prototype._getStatus=function(){return this.status},h.prototype._renderTemplate=function(){},h.prototype._initVariables=function(){this.status={},this.channels={}},h.prototype.renderBoxTab=function(){var e=t.extend(!0,{},this.config,{model:this.model,el:this.$el});this.box=new o(e)},h.prototype._destroyBoxTab=function(){this.box.dispose(),e.info("Destroyed BoxTab: "+this.id)},h.prototype._bindEventListeners=function(){},h.prototype._unbindEventListeners=function(){},h.prototype._dispose=function(){this._unbindEventListeners(),this._destroyBoxTab()},h.prototype._getEventName=function(t){return this.controller.id+t},h}.apply(e,s),!(void 0!==r&&(t.exports=r))},function(t,e){t.exports=a},function(t,e,i){var s,r;s=[i(3),i(4),i(8),i(5),i(6),i(7),i(16),i(11)],r=function(t,e,i,s,r,n,o,a){"use strict";function h(e){var i=this;return t.extend(!0,this,c,e),this.$el=t(this.el),this._renderTemplate(),this._initVariables(),this._renderChart(),this._bindEventListeners(),window.setTimeout(function(){i.status.ready=!0,a.publish(i._getEventName(r.SELECTOR_READY),i),i._trigger("ready")},0),this}var c={};return h.prototype.dispose=function(){this._dispose(),e.info("Selector disposed successfully")},h.prototype.refresh=function(){e.info("Item refresh successfully")},h.prototype.on=function(t,e,i){var s=i||this;return this.channels[t]||(this.channels[t]=[]),this.channels[t].push({context:s,callback:e}),this},h.prototype._trigger=function(t){if(!this.channels[t])return!1;for(var e=Array.prototype.slice.call(arguments,1),i=0,s=this.channels[t].length;i<s;i++){var r=this.channels[t][i];r.callback.apply(r.context,e)}return this},h.prototype._getStatus=function(){return this.status},h.prototype._renderTemplate=function(){},h.prototype._initVariables=function(){this.status={},this.channels={}},h.prototype._renderChart=function(){var e=t.extend(!0,{},this.config,{model:this.model,el:this.$el});new o(e)},h.prototype._destroyChart=function(){e.info("Destroyed Chart: "+this.id)},h.prototype._bindEventListeners=function(){},h.prototype._unbindEventListeners=function(){},h.prototype._dispose=function(){this._unbindEventListeners(),this._destroyChart()},h.prototype._getEventName=function(t){return this.controller.id+t},h}.apply(e,s),!(void 0!==r&&(t.exports=r))},function(t,e){t.exports=h},function(t,e,i){var s,r;s=[i(3),i(4),i(8),i(5),i(6),i(7),i(18),i(11)],r=function(t,e,i,s,r,n,o,a){"use strict";function h(e){var i=this;return t.extend(!0,this,c,e),this.$el=t(this.el),this._renderTemplate(),this._initVariables(),this._renderMap(),this._bindEventListeners(),window.setTimeout(function(){i.status.ready=!0,a.publish(i._getEventName(r.SELECTOR_READY),i),i._trigger("ready")},0),this}var c={};return h.prototype.dispose=function(){this._dispose(),e.info("Selector disposed successfully")},h.prototype.refresh=function(){e.info("Item refresh successfully")},h.prototype.on=function(t,e,i){var s=i||this;return this.channels[t]||(this.channels[t]=[]),this.channels[t].push({context:s,callback:e}),this},h.prototype._trigger=function(t){if(!this.channels[t])return!1;for(var e=Array.prototype.slice.call(arguments,1),i=0,s=this.channels[t].length;i<s;i++){var r=this.channels[t][i];r.callback.apply(r.context,e)}return this},h.prototype._getStatus=function(){return this.status},h.prototype._renderTemplate=function(){},h.prototype._initVariables=function(){this.status={},this.channels={}},h.prototype._renderMap=function(){var e=t.extend(!0,{},this.config,{model:this.model,el:this.$el});this.map=new o(e)},h.prototype._destroyMap=function(){this.map.dispose(),e.info("Destroyed Map: "+this.id)},h.prototype._bindEventListeners=function(){},h.prototype._unbindEventListeners=function(){},h.prototype._dispose=function(){this._unbindEventListeners(),this._destroyMap()},h.prototype._getEventName=function(t){return this.controller.id+t},h}.apply(e,s),!(void 0!==r&&(t.exports=r))},function(t,e){t.exports=c},function(t,e,i){var s,r;s=[i(3),i(4),i(8),i(5),i(6),i(7),i(20),i(11)],r=function(t,e,i,s,r,n,o,a){"use strict";function h(e){var i=this;return t.extend(!0,this,c,e),this.$el=t(this.el),this._renderTemplate(),this._initVariables(),this._renderOlap(),this._bindEventListeners(),window.setTimeout(function(){i.status.ready=!0,a.publish(i._getEventName(r.SELECTOR_READY),i),i._trigger("ready")},0),this}var c={};return h.prototype.dispose=function(){this._dispose(),e.info("Selector disposed successfully")},h.prototype.refresh=function(){e.info("Item refresh successfully")},h.prototype.on=function(t,e,i){var s=i||this;return this.channels[t]||(this.channels[t]=[]),this.channels[t].push({context:s,callback:e}),this},h.prototype._trigger=function(t){if(!this.channels[t])return!1;for(var e=Array.prototype.slice.call(arguments,1),i=0,s=this.channels[t].length;i<s;i++){var r=this.channels[t][i];r.callback.apply(r.context,e)}return this},h.prototype._getStatus=function(){return this.status},h.prototype._renderTemplate=function(){},h.prototype._initVariables=function(){this.status={},this.channels={}},h.prototype._renderOlap=function(){var e=t.extend(!0,{},this.config,{model:this.model,el:this.$el});new o(e)},h.prototype._destroyOlap=function(){e.info("Destroyed Table: "+this.id)},h.prototype._bindEventListeners=function(){},h.prototype._unbindEventListeners=function(){},h.prototype._dispose=function(){this._unbindEventListeners(),this._destroyOlap()},h.prototype._getEventName=function(t){return this.controller.id+t},h}.apply(e,s),!(void 0!==r&&(t.exports=r))},function(t,e){t.exports=p}])});
//# sourceMappingURL=fenix-ui-dashboard.min.js.map